# Deadlock detection files.

## Input

The data format of files that are generated by the deadlock detection mechanism, is a collection of files, named as `deadlock_detection_graphdump.tid.json`, where `tid` is the thread id of the thread executing specific operations. The files are generated in current working directory of Seastar application.

Each the files is a JSON lines document (i.e. each line, separated by line feed, is a valid JSON).
Each line represents an *event* -- for example, we note that some Seastar task begins waiting on a semaphore. The full description of possible events is below.

The usual concepts that are present are:
- `timestamp` - timestamp of a given event, given in nanoseconds, from some arbitrary point in time (used mainly for ordering),
- `vertex` - this is one of a `future`, a `promise`, a `task` and `null` (if for some reason it can't be determined), identified by an address. May contain `type` and `base_type` (as described below),
- `sem` - this is a semaphore, identified by its address,
- `address` - this is the address of a `vertex` or a `sem`, written as a decimal number,
- `type`, `base_type` - this describes some additional information about given vertex to ease up debugging

Since different `vertex`es and `sem`s can share the same address (after the previous one has been destroyed). That is why we introduce the concept of a generation counter. This parser recognizes creation and destruction of the vertices.

Each event receives mandatory arguments, which are the type of the event and its timestamp. Apart from that, events can convey various information. These are examples. Meanig of specific values, if missing, is described above.

### `sem_ctor`
The `available_units` dictates how many units are granted initially to the semaphore.
```
{
  "type": "sem_ctor",
  "sem": {
    "address": 105553116380984,
    "available_units": 9223372036854776000
  },
  "timestamp": 276639050981375
}
```

### `sem_dtor`
The `available_units` dictates how many units were still available for the semaphore at the end of semaphore lifetime.
```
{
  "type": "sem_dtor",
  "sem": {
    "address": 140737373917856,
    "available_units": 6
  },
  "timestamp": 276639082372623
}
```

### `vertex_ctor`
This is the vertex constructor.
```
{
  "type": "vertex_ctor",
  "vertex": {
    "address": 140737373918560,
    "base_type": "N7seastar8internal11future_baseE",
    "type": "N7seastar8internal11future_baseE"
  },
  "timestamp": 276639082376051
}
```

### `vertex_dtor`
This is the vertex destructor.
```
{
  "type": "vertex_dtor",
  "vertex": {
    "address": 140727395531856,
    "base_type": "N7seastar8internal11future_baseE",
    "type": "N7seastar8internal11future_baseE"
  },
  "timestamp": 17605944717185
}
```

### `sem_wait`
This represents the start of waiting on a semaphore. `pre` is the vertex that begun waiting, while `post` is the result of wait. Count parameter, is the number of units, that `pre` is requesting from the semaphore.
```
{
  "type": "sem_wait",
  "sem": {
    "address": 105553116380984
  },
  "pre": {
    "address": 105553117494848
  },
  "post": {
    "address": 140727395531440
  },
  "count": 1,
  "timestamp": 17605945355304
}
```

### `sem_wait_completed`
Describes the completion of a wait on semaphore. `post` parameter is the resulting vertex.
```
{
  "type": "sem_wait_completed",
  "sem": {
    "address": 105553116343288
  },
  "post": {
    "address": 140727395532144
  },
  "timestamp": 17605948302997
}
```

### `sem_signal`
This tells which `vertex` made a `signal` on semaphore. Also includes the signaling count.
```
{
  "type": "sem_signal",
  "sem": {
    "address": 105553117831624
  },
  "count": 1,
  "vertex": 105690556157856,
  "timestamp": 17605944047040
}
```

### `edge`
This is the edge between two vertices, `pre` and `post`. `speculative` is the parameter describing whether *TODO*
```
{
  "type": "edge",
  "pre": {
    "address": 140727395531568,
    "base_type": "N7seastar8internal11future_baseE",
    "type": "N7seastar8internal11future_baseE"
  },
  "post": {
    "address": 140727395531600,
    "base_type": "N7seastar8internal11future_baseE",
    "type": "N7seastar8internal11future_baseE"
  },
  "speculative": false,
  "timestamp": 17605950025482
}
```

### `attach_func_type`
This is used to attach additional debugging information. Currently the interface is not stable, but this kind of event can be safely ignored for deadlock detection itself.
```
{
  "type": "attach_func_type",
  "vertex": {
    "address": 105553117494552,
    "base_type": "N7seastar8internal12promise_baseE",
    "type": "N7seastar8internal22promise_base_with_typeIvEE"
  },
  "func_type": "ZZZN7seastar7reactor4stopEvENKUlvE_clEvENKUlRNS_15basic_semaphoreINS_35semaphore_default_exception_factoryENSt6chrono3_V212steady_clockEEEE_clES8_EUlvE0_",
  "file": "../../include/seastar/core/future.hh",
  "line": 1600,
  "timestamp": 17605951515060
}
```


The generated events:
- `sem_ctor`, sem=unique_id, count=initial_units
- `sem_dtor`, sem=unique_id
- `vertex_ctor`, vertex=unique_id
- `vertex_dtor`, vertex=unique_id
- `sem_wait`, sem=unique_id, pre=unique_id of vertex taking, post=unique_id of vertex receiving, count=units taken
- `sem_wait_completed`, sem=unique_id, post=unique_id of vertex receiving, count=units taken
- `sem_signal`, sem=unique_id, vertex=unique_id of signalling vertex, count=units returned
- `edge`, pre=unique_id, post=unique_id, speculative="0" or "1"


Data format on the output. There are JSONs on each line.
Each line describes an event. "type" field indicates the event. Each event has a timestamp, expressed in nanoseconds. Identifiers of semaphores and vertices are small integers.
